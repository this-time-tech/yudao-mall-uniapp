"use strict";const e=require("../../common/vendor.js"),r=require("../store/index.js"),a=require("./index.js"),s=require("../router/index.js"),t=require("../url/index.js"),i=require("../api/trade/brokerage.js"),n=require("../util/const.js"),o=["H5","WechatOfficialAccount","WechatMiniProgram","App"],u=["forward","poster","link"],d=e=>{const s=r.$store("user");let t="0";void 0===e.shareId&&s.isLogin&&(t=s.userInfo.id);let i=n.SharePageEnum.HOME.value;void 0!==e.page&&(i=e.page);let u="0";void 0!==e.query&&(u=e.query);let d=o.indexOf(a._platform.name)+1,g="1";return void 0!==e.from&&(g=o.indexOf(e.from)+1),`spm=${t}.${i}.${u}.${d}.${g}`},g=e=>void 0===e?"pages/index/index":`pages/index/index?${e}`,p=(e,r="")=>`${r}?${e}`,m=async r=>{try{const a=r||e.index.getStorageSync("shareId");if(!a)return;const{data:s}=await i.BrokerageApi.bindBrokerageUser({bindUserId:a});s&&e.index.removeStorageSync("shareId")}catch(a){console.error(a)}},c={getShareInfo:(e={title:"",desc:"",image:"",params:{}},a={type:"user"})=>{const s={title:"",desc:"",image:"",path:"",link:"",query:"",poster:a,forward:{}};s.title=e.title,s.image=t.$url.cdn(e.image),s.desc=e.desc;const i=r.$store("app").platform.share,n=d(e.params);return s.query=n,s.link=p(n,i.linkAddress),s.path=g(),i.methods.includes("forward")&&(s.forward.path=g(n)),s},updateShareInfo:e=>{},decryptSpm:a=>{const t=r.$store("user");let i=a.split("."),d={spm:a,shareId:0,page:"",query:{},platform:"",from:""};switch(d.shareId=i[0],i[1]){case n.SharePageEnum.HOME.value:d.page=n.SharePageEnum.HOME.page;break;case n.SharePageEnum.GOODS.value:d.page=n.SharePageEnum.GOODS.page,d.query={id:i[2]};break;case n.SharePageEnum.GROUPON.value:d.page=n.SharePageEnum.GROUPON.page,d.query={id:i[2]};break;case n.SharePageEnum.SECKILL.value:d.page=n.SharePageEnum.SECKILL.page,d.query={id:i[2]};break;case n.SharePageEnum.GROUPON_DETAIL.value:d.page=n.SharePageEnum.GROUPON_DETAIL.page,d.query={id:i[2]};break;case n.SharePageEnum.POINT.value:d.page=n.SharePageEnum.POINT.page,d.query={id:i[2]}}return d.platform=o[i[3]-1],d.from=u[i[4]-1],0!==d.shareId&&(e.index.setStorageSync("shareId",d.shareId),t.isLogin&&m(d.shareId)),d.page!==n.SharePageEnum.HOME.page&&s.$router.go(d.page,d.query),d},bindBrokerageUser:m};exports.$share=c;
