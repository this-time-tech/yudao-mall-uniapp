"use strict";const e=require("../../common/vendor.js"),o=require("../config/index.js"),r=require("../store/index.js"),t=require("../platform/index.js"),s=require("../hooks/useModal.js"),a=require("../api/member/auth.js"),n=require("../util/const.js");let i={target:null,count:0};function c(){i.count>0&&i.count--,0===i.count&&e.index.hideLoading()}const u=new e.Request({baseURL:o.baseUrl+o.apiPath,timeout:8e3,method:"GET",header:{Accept:"text/json","Content-Type":"application/json;charset=UTF-8",platform:t._platform.name},custom:{showSuccess:!1,successMsg:"",showError:!0,errorMsg:"",showLoading:!0,loadingMsg:"加载中",auth:!1}});u.interceptors.request.use((t=>{if(t.custom.auth&&!r.$store("user").isLogin)return s.showAuthModal(),Promise.reject();t.custom.showLoading&&(i.count++,1===i.count&&e.index.showLoading({title:t.custom.loadingMsg,mask:!0,fail:()=>{e.index.hideLoading()}}));const a=l();return a&&(t.header.Authorization=a),t.header.terminal=n.getTerminal(),t.header.Accept="*/*",t.header["tenant-id"]=o.tenantId,t}),(e=>Promise.reject(e))),u.interceptors.response.use((o=>{var t,s;if(o.config.url.indexOf("/member/auth/")>=0&&(null==(s=null==(t=o.data)?void 0:t.data)?void 0:s.accessToken)&&r.$store("user").setToken(o.data.data.accessToken,o.data.data.refreshToken),o.config.custom.showLoading&&c(),0!==o.data.code){if(401===o.data.code)return g(o.config);(o.data.code+"").includes("1011007")?console.error(`分销用户绑定失败，原因：${o.data.msg}`):o.config.custom.showError&&e.index.showToast({title:o.data.msg||"服务器开小差啦,请稍后再试~",icon:"none",mask:!0})}return o.config.custom.showSuccess&&""!==o.config.custom.successMsg&&0===o.data.code&&e.index.showToast({title:o.config.custom.successMsg,icon:"none"}),Promise.resolve(o.data)}),(o=>{var t;const s=r.$store("user").isLogin;let a="网络请求出错";if(void 0!==o){switch(o.statusCode){case 400:a="请求错误";break;case 401:a=s?"您的登陆已过期":"请先登录";break;case 403:a="拒绝访问";break;case 404:a="请求出错";break;case 408:a="请求超时";break;case 429:a="请求频繁, 请稍后再访问";break;case 500:a="服务器开小差啦,请稍后再试~";break;case 501:a="服务未实现";break;case 502:a="网络错误";break;case 503:a="服务不可用";break;case 504:a="网络超时";break;case 505:a="HTTP 版本不受支持"}o.errMsg.includes("timeout")&&(a="请求超时")}return o&&o.config&&(!1===o.config.custom.showError&&e.index.showToast({title:(null==(t=o.data)?void 0:t.msg)||a,icon:"none",mask:!0}),o.config.custom.showLoading&&c()),!1}));let d=[],h=!1;const g=async e=>{if(e.url.indexOf("/member/auth/refresh-token")>=0)return Promise.reject("error");if(h)return new Promise((o=>{d.push((()=>{e.header.Authorization="Bearer "+l(),o(k(e))}))}));{h=!0;const r=f();if(!r)return m();try{if(0!==(await a.AuthUtil.refreshToken(r)).code)throw new Error("刷新令牌失败");return e.header.Authorization="Bearer "+l(),d.forEach((e=>{e()})),d=[],k(e)}catch(o){return d.forEach((e=>{e()})),m()}finally{d=[],h=!1}}},m=()=>{const e=r.$store("user");return e.logout(!0),s.showAuthModal(),Promise.reject({code:401,msg:e.isLogin?"您的登陆已过期":"请先登录"})},l=()=>e.index.getStorageSync("token"),f=()=>e.index.getStorageSync("refresh-token"),k=e=>u.middleware(e),w=k;exports.getRefreshToken=f,exports.request=w;
