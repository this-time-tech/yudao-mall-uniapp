"use strict";const e=require("../../common/vendor.js"),r=require("../../sheep/index.js"),s=require("../../sheep/api/pay/order.js"),t=require("../../sheep/hooks/useGoods.js"),o=require("../../sheep/api/trade/order.js"),a=require("../../sheep/util/const.js");if(!Array){e.resolveComponent("s-layout")()}Math;const u={__name:"result",setup(u){const d=e.reactive({id:0,orderType:"goods",result:"unpaid",orderInfo:{},tradeOrder:{},counter:0}),i=e.computed((()=>"unpaid"===d.result?"waiting":"paid"===d.result?"success":"failed"===d.result?"failed":"closed"===d.result?"closed":void 0));async function c(r){d.counter++;const{data:t,code:a}=await s.PayOrderApi.getOrder(r);if(0===a){if(d.orderInfo=t,!d.orderInfo||30===d.orderInfo.status)return void(d.result="closed");if(0!==d.orderInfo.status){if(d.result="paid",e.index.showModal({title:"支付结果",showCancel:!1,content:"支付成功",success:()=>{!async function(){if(!e.index.getStorageSync("subscribe_btn_status"))return void(l.value=!0);p()}()}}),"goods"===d.orderType){const{data:e,code:r}=await o.OrderApi.getOrderDetail(d.orderInfo.merchantOrderId,!0);0===r&&(d.tradeOrder=e)}return}}d.counter<3&&"unpaid"===d.result&&setTimeout((()=>{c(r)}),1500),d.counter>=3&&(d.result="failed")}function n(){"recharge"===d.orderType?r.sheep.$router.redirect("/pages/pay/recharge-log"):r.sheep.$router.redirect("/pages/order/list")}const l=e.ref(!1);function p(){if("goods"!==d.orderType)return;const s=[a.WxaSubscribeTemplate.TRADE_ORDER_DELIVERY];3===d.tradeOrder.type&&s.push(a.WxaSubscribeTemplate.PROMOTION_COMBINATION_SUCCESS),r.sheep.$platform.useProvider("wechat").subscribeMessage(s,(()=>{e.index.removeStorageSync("subscribe_btn_status"),e.index.setStorageSync("subscribe_btn_status","已订阅"),l.value=!1}))}return e.onLoad((async e=>{e.id&&(d.id=e.id),e.orderType&&(d.orderType=e.orderType),"fail"===e.payState?d.result="failed":await c(d.id)})),e.onShow((()=>{e.isEmpty(d.orderInfo)||c(d.id)})),e.onHide((()=>{d.result="unpaid",d.counter=0})),(s,o)=>e.e({a:"waiting"===i.value},(i.value,{}),{b:"success"===i.value},"success"===i.value?{c:e.unref(r.sheep).$url.static("/static/img/shop/order/order_pay_success.gif")}:{},{d:["failed","closed"].includes(i.value)},["failed","closed"].includes(i.value)?{e:e.unref(r.sheep).$url.static("/static/img/shop/order/order_paty_fail.gif")}:{},{f:"success"===i.value},(i.value,{}),{g:"failed"===i.value},(i.value,{}),{h:"closed"===i.value},(i.value,{}),{i:"waiting"===i.value},(i.value,{}),{j:"success"===i.value},"success"===i.value?{k:e.t(e.unref(t.fen2yuan)(d.orderInfo.price))}:{},{l:e.o((s=>e.unref(r.sheep).$router.go("/pages/index/index"))),m:"failed"===i.value},"failed"===i.value?{n:e.o((s=>e.unref(r.sheep).$router.redirect("/pages/pay/index",{id:d.id,orderType:d.orderType})))}:{},{o:"success"===i.value},"success"===i.value?{p:e.o(n)}:{},{q:"success"===i.value&&3===d.tradeOrder.type},"success"===i.value&&3===d.tradeOrder.type?{r:e.o((s=>e.unref(r.sheep).$router.redirect("/pages/activity/groupon/order")))}:{},{s:l.value&&"goods"===d.orderType},l.value&&"goods"===d.orderType?{t:e.unref(r.sheep).$url.static("/static/img/shop/order/cargo.png"),v:e.o(p)}:{},{w:e.p({bgStyle:{color:"#FFF"},title:"支付结果"})})}},d=e._export_sfc(u,[["__scopeId","data-v-879c5792"]]);wx.createPage(d);
